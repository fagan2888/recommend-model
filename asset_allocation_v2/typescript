Script started on Thu 08 Nov 2018 10:22:52 AM CST
]0;bae@fd3d2f0db4d6:~/recommend_model/asset_allocation_v2[?1034h[bae@fd3d2f0db4d6 asset_allocation_v2]$ vi[K[Kcdd[K[K[Kcd position[K[K[K[K[K[K[K[Kchange_posiz[Ktion
bash: cd: change_position: No such file or directory
]0;bae@fd3d2f0db4d6:~/recommend_model/asset_allocation_v2[bae@fd3d2f0db4d6 asset_allocation_v2]$ cd 
]0;bae@fd3d2f0db4d6:~[bae@fd3d2f0db4d6 ~]$ cd recommend+_[K[K_model
]0;bae@fd3d2f0db4d6:~/recommend_model[bae@fd3d2f0db4d6 recommend_model]$ cd change_position
]0;bae@fd3d2f0db4d6:~/recommend_model/change_position[bae@fd3d2f0db4d6 change_position]$ ls
[0m[01;34mdata[0m  [01;34mmatlab[0m  [01;34mshell[0m
]0;bae@fd3d2f0db4d6:~/recommend_model/change_position[bae@fd3d2f0db4d6 change_position]$ [K[bae@fd3d2f0db4d6 change_position]$ cd asset[Kt_alooca[K[K[K[Klocation_v2
bash: cd: asset_allocation_v2: No such file or directory
]0;bae@fd3d2f0db4d6:~/recommend_model/change_position[bae@fd3d2f0db4d6 change_position]$ ll
total 12
drwxrwxr-x 2 bae bae 4096 Oct  9 18:03 [0m[01;34mdata[0m
drwxrwxr-x 2 bae bae 4096 Oct  9 18:03 [01;34mmatlab[0m
drwxrwxr-x 2 bae bae 4096 Oct  9 18:03 [01;34mshell[0m
]0;bae@fd3d2f0db4d6:~/recommend_model/change_position[bae@fd3d2f0db4d6 change_position]$ cd ..[K[K[K[K[Kcd ..
]0;bae@fd3d2f0db4d6:~/recommend_model[bae@fd3d2f0db4d6 recommend_model]$ ll
total 64
drwxrwxr-x 7 bae bae 4096 Oct  9 18:03 [0m[01;34masset_allocation_v1[0m
drwxrwxr-x 4 bae bae 4096 Nov  8 10:22 [01;34masset_allocation_v2[0m
drwxrwxr-x 5 bae bae 4096 Oct  9 18:03 [01;34mchange_position[0m
drwxrwxr-x 4 bae bae 4096 Oct  9 18:03 [01;34mexport_data[0m
drwxrwxr-x 6 bae bae 4096 Oct  9 18:03 [01;34mfinancial_experiment[0m
drwxrwxr-x 3 bae bae 4096 Oct  9 18:03 [01;34mfund_data[0m
drwxrwxr-x 4 bae bae 4096 Oct  9 18:03 [01;34mhedgefund_cluster[0m
drwxrwxr-x 3 bae bae 4096 Oct  9 18:03 [01;34mhs300_mv_zz500[0m
drwxrwxr-x 6 bae bae 4096 Oct  9 18:03 [01;34minvest[0m
drwxrwxr-x 4 bae bae 4096 Oct  9 18:03 [01;34mmcppi[0m
drwxrwxr-x 3 bae bae 4096 Oct  9 18:03 [01;34mpython_data[0m
drwxrwxr-x 4 bae bae 4096 Oct  9 18:03 [01;34mquant[0m
-rw-rw-r-- 1 bae bae   18 Oct  9 18:03 README.md
drwxrwxr-x 4 bae bae 4096 Oct  9 18:03 [01;34mr_experiment[0m
drwxrwxr-x 2 bae bae 4096 Oct  9 18:03 [01;34mtc[0m
drwxrwxr-x 3 bae bae 4096 Oct  9 18:03 [01;34muser_analysis[0m
]0;bae@fd3d2f0db4d6:~/recommend_model[bae@fd3d2f0db4d6 recommend_model]$ cd asset_allocation_v2/
]0;bae@fd3d2f0db4d6:~/recommend_model/asset_allocation_v2[bae@fd3d2f0db4d6 asset_allocation_v2]$ ll
total 16
-rw-rw-r-- 1 bae bae 6209 Oct  9 18:03 factor.sh
drwxrwxr-x 2 bae bae 4096 Oct  9 18:03 [0m[01;34mscript[0m
drwxrwxr-x 4 bae bae 4096 Oct 15 19:47 [01;34mshell[0m
-rw-rw-r-- 1 bae bae    0 Nov  8 10:22 typescript
]0;bae@fd3d2f0db4d6:~/recommend_model/asset_allocation_v2[bae@fd3d2f0db4d6 asset_allocation_v2]$ ll
total 16
-rw-rw-r-- 1 bae bae 6209 Oct  9 18:03 factor.sh
drwxrwxr-x 2 bae bae 4096 Oct  9 18:03 [0m[01;34mscript[0m
drwxrwxr-x 4 bae bae 4096 Oct 15 19:47 [01;34mshell[0m
-rw-rw-r-- 1 bae bae    0 Nov  8 10:22 typescript
]0;bae@fd3d2f0db4d6:~/recommend_model/asset_allocation_v2[bae@fd3d2f0db4d6 asset_allocation_v2]$ vi shell/
allocate.py                  CommandHighlow.py            .CommandStockFactor.py.swp   FundIndicator.py             RiskMgrSimple.py             trade_date.py
asset_allocate.py            CommandImport.py             CommandTiming.py             FundSelector.py              RiskMgrVaRs.py               TradeNav.py
asset.py                     CommandInvestor.py           CommandUtil.py               hmm_incremental.py           RiskParity.py                TradeUtil.py
cal_tech_indic.py            CommandMacroTiming.py        CommandView.py               IndexFactor.py               roboadvisor.py               util/
CommandAnalysis.py           CommandMarkowitz.py          Const.py                     __init__.py                  srrc.py                      util_numpy.py
CommandCompositeAsset.py     CommandModelRisk.py          db/                          LabelAsset.py                sta_mothly.py                util_optimize.py
CommandExchangeRateIndex.py  CommandOnline.py             DBData.py                    logging.json.example         stock_factor.py              utils.py
CommandExport.py             CommandPool.py               DFUtil.py                    Portfolio.py                 StockFactorTest.py           view.py
CommandFactorClusterNew.py   CommandPortfolio.py          factor.py                    PureFactor.py                StockTag.py                  wavelet.py
CommandFactorCluster.py      CommandRiskManage.py         Financial.py                 RiskMgrGARCHHelper.py        TimingGFTD.py                
CommandFundFactor.py         CommandStockFactorNew.py     fund_factor.py               RiskMgrGARCH.py              TimingHmm.py                 
CommandFund.py               CommandStockFactor.py        FundFilter.py                RiskMgrLow.py                TimingWavelet.py             
[bae@fd3d2f0db4d6 asset_allocation_v2]$ vi shell/V[KCO[KommandRiskManage.py 
[?1049h[?1h=[2;1H‚ñΩ[6n[1;1H  [1;1H[1;64r[?12;25h[?12l[?25h[27m[m[H[2J[?25l[64;1H"shell/CommandRiskManage.py" 653L, 24175C[>c[1;1H[34m#coding=utf8[m


[35mimport[m logging
[35mimport[m string
[35mimport[m json
[35mimport[m os
[35mimport[m sys
sys.path.append([31m'shell'[m)
[35mimport[m click
[35mimport[m pandas [33mas[m pd
[35mimport[m numpy [33mas[m np
[35mimport[m os
[35mimport[m util_numpy [33mas[m npu
[35mimport[m DBData
[35mimport[m time
[35mimport[m Const
[35mimport[m RiskMgrSimple
[35mimport[m RiskMgrLow
[34m# import RiskMgrGARCH
# import RiskMgrVaRs[m
[35mimport[m DFUtil

[35mfrom[m datetime [35mimport[m datetime, timedelta
[35mfrom[m dateutil.parser [35mimport[m parse
[35mfrom[m Const [35mimport[m datapath
[35mfrom[m tabulate [35mimport[m tabulate
[35mfrom[m sqlalchemy [35mimport[m MetaData, Table, select, func
[35mfrom[m db [35mimport[m *
[35mfrom[m queue [35mimport[m Queue

[35mimport[m traceback, code

logger = logging.getLogger(__name__)

[35m@[m[36mclick.group[m(invoke_without_command=[36mTrue[m)
[35m@[m[36mclick.option[m([31m'--id'[m, [31m'optid'[m, [36mhelp[m=[31m'reshape id'[m)
[35m@[m[36mclick.option[m([31m'--online/--no-online'[m, [31m'optonline'[m, default=[36mFalse[m, [36mhelp[m=[31m'include online instance'[m)
[35m@[m[36mclick.pass_context[m
[33mdef[m [36mriskmgr[m(ctx, optid, optonline):
    [31m'''risk management group
    '''[m
    [33mif[m ctx.invoked_subcommand [33mis[m [36mNone[m:[44;9H[34m# click.echo('I was invoked without subcommand')[m[45;9Hctx.invoke(calc_vars, optid=optid)[46;9Hctx.invoke(signal, optid=optid, optonline=optonline)[47;9Hctx.invoke(nav, optid=optid)
    [33melse[m:[49;9H[34m# click.echo('I am about to invoke %s' % ctx.invoked_subcommand)[m[50;9H[33mpass[m

[35m@[m[36mriskmgr.command[m()
[35m@[m[36mclick.option[m([31m'--datadir'[m, [31m'-d'[m, [36mtype[m=click.Path(exists=[36mTrue[m), default=[31m'./tmp'[m, [36mhelp[m=[31m'dir used to store tmp data'[m)
[35m@[m[36mclick.option[m([31m'--start-date'[m, [31m'startdate'[m, default=[31m'2012-07-15'[m, [36mhelp[m=[31m'start date to calc'[m)
[35m@[m[36mclick.option[m([31m'--end-date'[m, [31m'enddate'[m, [36mhelp[m=[31m'end date to calc'[m)
[35m@[m[36mclick.option[m([31m'--label-asset/--no-label-asset'[m, default=[36mTrue[m)
[35m@[m[36mclick.option[m([31m'--reshape/--no-reshape'[m, default=[36mTrue[m)
[35m@[m[36mclick.option[m([31m'--markowitz/--no-markowitz'[m, default=[36mTrue[m)
[35m@[m[36mclick.pass_context[m
[33mdef[m [36mtest[m(ctx, datadir, startdate, enddate, label_asset, reshape, markowitz):
    [31m'''run risk management using simple strategy
    '''[m
    Const.datadir = datadir[64;168H34,1[10CTop[34;1H[?12l[?25h[?25l[1;63r[1;1H[31M[1;64r[34;5H[33mif[m [33mnot[m enddate:[35;9Hyesterday = (datetime.now() - timedelta(days=[31m1[m));[36;9Henddate = yesterday.strftime([31m"%Y-%m-%d"[m)[38;5Hdf_nav = pd.read_csv(datapath([31m'../csvdata/000300_nav_2012.csv'[m),  index_col=[[31m'date'[m], parse_dates=[[31m'date'[m])
    [34m#df_nav = pd.read_csv(datapath('dd.csv'),  index_col=['td_date'], parse_dates=['td_date'])[41;5H#df_pos = pd.read_csv(datapath('port_weight.csv'),  index_col=['date'], parse_dates=['date'])[m[43;5Hdf_timing = pd.read_csv(datapath([31m'hs_gftd.csv'[m),  index_col=[[31m'date'[m], parse_dates=[[31m'date'[m], usecols=[[31m'date'[m, [31m'trade_types'[m])
    [34m#df_timing = pd.read_csv(datapath('../csvdata/000300_gftd_result.csv'),  index_col=['date'], parse_dates=['date'], usecols=['date', 'trade_types'])[m
    df_timing = df_timing.rename(columns={[31m'trade_types'[m:[31m'sh000300'[m})[47;5Hdf = pd.DataFrame({[48;9H[31m'nav'[m: df_nav.iloc[:, [31m0[m],[49;9H[31m'timing'[m: df_timing[[31m'sh000300'[m].reindex(df_nav.index, method=[31m'pad'[m)
    })[52;5Hrisk_mgr = RiskManagement.RiskManagement()
    df_result = risk_mgr.perform([31m'sh000300'[m, df)[55;5Hdf_result.to_csv(datapath([31m'riskmgr_result.csv'[m))

[35m@[m[36mriskmgr.command[m()
[35m@[m[36mclick.option[m([31m'--inst'[m, [31m'optinst'[m, [36mtype[m=[36mint[m, [36mhelp[m=[31m'risk mgr id'[m)
[35m@[m[36mclick.option[m([31m'--datadir'[m, [31m'-d'[m, [36mtype[m=click.Path(exists=[36mTrue[m), default=[31m'./tmp'[m, [36mhelp[m=[31m'dir used to store tmp data'[m)
[35m@[m[36mclick.option[m([31m'--start-date'[m, [31m'startdate'[m, [36mhelp[m=[31m'start date to calc'[m)
[35m@[m[36mclick.option[m([31m'--end-date'[m, [31m'enddate'[m, [36mhelp[m=[31m'end date to calc'[m)
[35m@[m[36mclick.pass_context[m
[33mdef[m [36msimple[m(ctx, datadir, optinst, startdate, enddate):[64;1H[K[64;168H65,5[11C5%[34;5H[?12l[?25h[?25l[1;63r[1;1H[31M[1;64r[33;5H[31m'''run risk management using simple strategy
    '''[m
    Const.datadir = datadir[37;5H[33mif[m [33mnot[m enddate:[38;9Hyesterday = (datetime.now() - timedelta(days=[31m1[m));[39;9Henddate = yesterday.strftime([31m"%Y-%m-%d"[m)[41;5H[33mif[m optinst [33mis[m [36mNone[m:[42;9Hoptinst = [31m2016120600[m[44;5Hmake_rm_risk_mgr_if_not_exist(optinst)[46;5Hdf_nav = pd.read_csv(datapath([31m'equalriskasset.csv'[m),  index_col=[[31m'date'[m], parse_dates=[[31m'date'[m])
    [33mif[m [33mnot[m startdate:[48;9Hstartdate = df_nav.index.[36mmin[m().strftime([31m"%Y-%m-%d"[m)[50;5Htiming_ids = [[31m'49101'[m, [31m'49201'[m, [31m'49301'[m, [31m'49401'[m]
    df_timing = database.asset_tc_timing_signal_load([52;9Htiming_ids, begin_date=startdate, end_date=enddate)[54;5Htasks = {[55;9H[31m'largecap'[m[7C: [[31m49101[m, [31m11[m],[56;9H[31m'smallcap'[m[7C: [[31m49101[m, [31m12[m],[57;9H[31m'rise'[m[11C: [[31m49101[m, [31m13[m],[58;9H[31m'oscillation'[m    : [[31m49101[m, [31m14[m],[59;9H[31m'decline'[m[8C: [[31m49101[m, [31m15[m],[60;9H[31m'growth'[m[9C: [[31m49101[m, [31m16[m],[61;9H[31m'value'[m[10C: [[31m49101[m, [31m17[m],[62;9H[31m'SP500.SPI'[m      : [[31m49201[m, [31m41[m],[63;9H[31m'GLNC'[m[11C: [[31m49301[m, [31m42[m],[64;168H[K[64;168H96,5[10C10%[34;5H[?12l[?25h[?25l[1;63r[1;1H[31M[1;64r[33;9H[31m'HSCI.HI'[m[8C: [[31m49401[m, [31m43[m],[34;9H[31m'convertiblebond'[m: [36mNone[m,[35;9H[31m'creditbond'[m     : [36mNone[m,[36;9H[31m'money'[m[10C: [36mNone[m,[37;9H[31m'ratebond'[m[7C: [36mNone[m,
    }[40;5Hdata = {}
    risk_mgr = RiskManagement.RiskManagement()
    [33mfor[m asset [33min[m df_nav.columns:[43;9H[34m#[44;9H# ËÆ°ÁÆóÈ£éÊéß‰ªì‰Ωç[45;9H#[m[46;9H[33mif[m tasks[asset] [33mis[m [36mNone[m:[47;13H[33mcontinue[m[49;9Htiming_id, category = tasks[asset][51;9Hdf = pd.DataFrame({[52;13H[31m'nav'[m: df_nav[asset],[53;13H[31m'timing'[m: df_timing[timing_id].reindex(df_nav.index, method=[31m'pad'[m)[54;9H})[56;9Hdf_new = risk_mgr.perform(asset, df)[58;9Hdf_new[[31m'rm_risk_mgr_id'[m] = optinst[59;9Hdf_new[[31m'rm_category'[m] = category[60;9Hdf_new = df_new.reset_index().set_index([[31m'rm_risk_mgr_id'[m, [31m'rm_category'[m, [31m'rm_date'[m])[61;9H[33mif[m [33mnot[m df_new.empty:[62;13Hdf_new = df_new.applymap([31m"{:.0f}"[m.[36mformat[m)[64;168H[K[64;168H127,9[9C15%[34;9H[?12l[?25h[?25l[1;63r[1;1H[31M[1;64r[33;9H[34m#[34;9H# ‰øùÂ≠òÈ£éÊéß‰ªì‰ΩçÂà∞Êï∞ÊçÆÂ∫ì[35;9H#[m[36;9Hdb = database.connection([31m'asset'[m)[37;9Ht2 = Table([31m'rm_risk_mgr_signal'[m, MetaData(bind=db), autoload=[36mTrue[m)[38;9Hcolumns2 = [[39;13Ht2.c.rm_risk_mgr_id,[40;13Ht2.c.rm_category,[41;13Ht2.c.rm_date,[42;13Ht2.c.rm_action,[43;13Ht2.c.rm_pos,[44;9H][45;9Hs = select(columns2, (t2.c.rm_risk_mgr_id == optinst) & (t2.c.rm_category == category))[46;9Hdf_old = pd.read_sql(s, db, index_col=[[31m'rm_risk_mgr_id'[m, [31m'rm_category'[m, [31m'rm_date'[m], parse_dates=[[31m'rm_date'[m])[47;9H[33mif[m [33mnot[m df_old.empty:[48;13Hdf_old = df_old.applymap([31m"{:.0f}"[m.[36mformat[m)[50;9H[34m# Êõ¥Êñ∞Êï∞ÊçÆÂ∫ì[51;9H# print df_new.head()[52;9H# print df_old.head()[m[53;9Hdatabase.batch(db, t2, df_new, df_old, timestamp=[36mFalse[m)[55;5H[34m#
[m    [34m# ÂêàÂπ∂ markowitz ‰ªì‰Ωç ‰∏é È£éÊéß ÁªìÊûú
[m    [34m#[m
    df_pos_markowitz = pd.read_csv(datapath([31m'portfolio_position.csv'[m), index_col=[[31m'date'[m], parse_dates=[[31m'date'[m])[60;5Hdf_pos_riskmgr = database.asset_rm_risk_mgr_signal_load(optinst)[62;5H[33mfor[m column [33min[m df_pos_riskmgr.columns:[63;9Hcategory = DFUtil.categories_name(column)[64;168H[K[64;168H158,9[9C21%[34;9H[?12l[?25h[?25l[1;63r[1;1H[31M[1;64r[33;9H[34m# if column < 20:[34;9H#     rmc = 11[35;9H# else:[36;9H#     rmc = column[m[37;9Hrmc = column[38;9H[34m# print "use column %d for category %s" % (rmc, category)[m[40;9H[33mif[m category [33min[m df_pos_markowitz:[41;13Hdf_pos_tmp = df_pos_riskmgr[rmc].reindex(df_pos_markowitz.index)[42;13Hdf_pos_markowitz[category] = df_pos_markowitz[category] * df_pos_tmp[44;5Hdf_result = df_pos_markowitz.reset_index().set_index([[31m'risk'[m, [31m'date'[m])[46;5H[34m#
[m    [34m# Ë∞ÉÊï¥Ë¥ßÂ∏ÅÁöÑÊØî‰æã, ÊÄªÂíåËææÂà∞1
[m    [34m#[m
    df_result[[31m'money'[m] = ([31m1[m - (df_result.[36msum[m(axis=[31m1[m) - df_result[[31m'money'[m]))[51;5Hdf_result.to_csv(datapath([31m'riskmgr_position.csv'[m))

[33mdef[m [36mmake_rm_risk_mgr_if_not_exist[m(id_):
    db = database.connection([31m'asset'[m)
    t2 = Table([31m'rm_risk_mgr'[m, MetaData(bind=db), autoload=[36mTrue[m)
    columns2 = [[57;9Ht2.c.globalid,[58;9Ht2.c.rm_inst_id,
    ]
    s = select(columns2, (t2.c.globalid == id_))
    df = pd.read_sql(s, db, index_col=[[31m'globalid'[m])
    [33mif[m [33mnot[m df.empty:[63;9H[33mreturn[m [36mTrue[m[64;168H[K[64;168H189,9[9C26%[34;9H[?12l[?25h[?25l[1;63r[1;1H[31M[1;64r[33;5H[34m#
[m    [34m# ÂØºÂÖ•Êï∞ÊçÆ
[m    [34m#[m
    row = {[37;9H[31m'globalid'[m: id_, [31m'rm_inst_id'[m: id_, [31m'created_at'[m: func.now(), [31m'updated_at'[m: func.now()
    }
    t2.insert(row).execute()[41;5H[33mreturn[m [36mTrue[m

[35m@[m[36mriskmgr.command[m(name=[31m'import'[m)
[35m@[m[36mclick.option[m([31m'--id'[m, [31m'optid'[m, [36mtype[m=[36mint[m, [36mhelp[m=[31m'specify markowitz id'[m)
[35m@[m[36mclick.option[m([31m'--name'[m, [31m'optname'[m,  [36mhelp[m=[31m'specify riskmgr name'[m)
[35m@[m[36mclick.option[m([31m'--type'[m, [31m'opttype'[m, [36mtype[m=click.Choice([[31m'1'[m, [31m'9'[m]), default=[31m'1'[m, [36mhelp[m=[31m'online type(1:expriment; 9:online)'[m)
[35m@[m[36mclick.option[m([31m'--replace/--no-replace'[m, [31m'optreplace'[m, default=[36mFalse[m, [36mhelp[m=[31m'replace pool if exists'[m)
[35m@[m[36mclick.argument[m([31m'csv'[m, [36mtype[m=click.Path(exists=[36mTrue[m, file_okay=[36mTrue[m, dir_okay=[36mFalse[m, readable=[36mTrue[m, resolve_path=[36mFalse[m), required=[36mTrue[m)
[35m@[m[36mclick.pass_context[m
[33mdef[m [36mimport_command[m(ctx, csv, optid, optname, opttype, optreplace):
    [31m'''
    import risk management position from csv file
    '''[m[55;5H[34m#
[m    [34m# Â§ÑÁêÜidÂèÇÊï∞
[m    [34m#[m
    [33mif[m optid [33mis[m [33mnot[m [36mNone[m:[59;9H[34m#[60;9H# Ê£ÄÊü•idÊòØÂê¶Â≠òÂú®[61;9H#[m[62;9Hdf_existed = asset_rm_risk_mgr.load([[36mstr[m(optid)])[63;9H[33mif[m [33mnot[m df_existed.empty:[64;168H[K[64;168H220,5[9C31%[34;5H[?12l[?25h[?25l[1;63r[1;1H[31M[1;64r[33;13Hs = [31m'riskmgr instance [%d] existed'[m % optid[34;13H[33mif[m optreplace:[35;17Hclick.echo(click.style([31m"%s, will replace!"[m % s, fg=[31m"yellow"[m))[36;13H[33melse[m:[37;17Hclick.echo(click.style([31m"%s, import aborted!"[m % s, fg=[31m"red"[m))[38;13H[33mreturn[m -[31m1[m;
    [33melse[m:[40;9H[34m#[41;9H# Ëá™Âä®ÁîüÊàêid[42;9H#[m[43;9Htoday = datetime.now()[44;9Hprefix = [31m'60'[m + today.strftime([31m"%m%d"[m);[45;9H[33mif[m opttype == [31m'9'[m:[46;13Hbetween_min, between_max = ([31m'%s90'[m % (prefix), [31m'%s99'[m % (prefix))[47;9H[33melse[m:[48;13Hbetween_min, between_max = ([31m'%s00'[m % (prefix), [31m'%s89'[m % (prefix))[50;9Hmax_id = asset_rm_risk_mgr.max_id_between(between_min, between_max)[51;9H[33mif[m max_id [33mis[m [36mNone[m:[52;13Hoptid = between_min[53;9H[33melse[m:[54;13H[33mif[m max_id >= between_max:[55;17Hs = [31m"run out of instance id [%d]"[m % max_id[56;17Hclick.echo(click.style([31m"%s, import aborted!"[m % s, fg=[31m"red"[m))[57;17H[33mreturn[m -[31m1[m[59;13H[33mif[m optreplace:[60;17Hoptid = max_id[61;13H[33melse[m:[62;17Hoptid = max_id + [31m1[m;[64;168H[K[64;168H251,13[8C36%[34;13H[?12l[?25h[?25l[1;63r[1;1H[31M[1;64r[33;5H[34m#
[m    [34m# Â§ÑÁêÜnameÂèÇÊï∞
[m    [34m#[m
    [33mif[m optname [33mis[m [36mNone[m:[37;9Hoptname = os.path.basename(csv);[39;5Hdb = database.connection([31m'asset'[m)
    metadata = MetaData(bind=db)
    rm_risk_mgr = Table([31m'rm_risk_mgr'[m, metadata, autoload=[36mTrue[m)
    rm_risk_mgr_pos = Table([31m'rm_risk_mgr_pos'[m, metadata, autoload=[36mTrue[m)
    [34m# rm_risk_mgr_nav = Table('rm_risk_mgr_nav', metadata, autoload=True)[45;5H#
[m    [34m# Â§ÑÁêÜÊõøÊç¢
[m    [34m#[m
    [33mif[m optreplace:[49;9Hrm_risk_mgr.delete(rm_risk_mgr.c.globalid == optid).execute()[50;9Hrm_risk_mgr_pos.delete(rm_risk_mgr_pos.c.rm_risk_mgr_id == optid).execute()[51;9H[34m# rm_risk_mgr_nav.delete(rm_risk_mgr_nav.c.rm_risk_mgr_id == optid).execute()[m[53;5Hnow = datetime.now()
    [34m#
[m    [34m# ÂØºÂÖ•Êï∞ÊçÆ
[m    [34m#[m
    row = {[58;9H[31m'globalid'[m: optid, [31m'rm_type'[m:opttype, [31m'rm_name'[m: optname,[59;9H[31m'rm_pool'[m: [31m''[m, [31m'rm_reshape'[m: [31m''[m, [31m'rm_markowitz'[m: [31m''[m, [31m'created_at'[m: func.now(), [31m'updated_at'[m: func.now()
    }
    rm_risk_mgr.insert(row).execute()[63;5Hdf = pd.read_csv(csv, parse_dates=[[31m'date'[m])[64;168H[K[64;168H282,5[9C42%[34;5H[?12l[?25h[?25l[1;63r[1;1H[31M[1;64r[33;5Hdf[[31m'risk'[m] = (df[[31m'risk'[m] * [31m10[m).astype([36mint[m)
    renames = [36mdict[m([35;9H[36mlist[m({[31m'date'[m:[31m'rm_date'[m, [31m'risk'[m:[31m'rm_alloc_id'[m}.items()) + [36mlist[m(DFUtil.categories_types(as_int=[36mTrue[m).items())
    )
    df = df.rename(columns=renames)
    df[[31m'rm_risk_mgr_id'[m] = optid[40;5Hdf.set_index([[31m'rm_risk_mgr_id'[m, [31m'rm_alloc_id'[m, [31m'rm_date'[m], inplace=[36mTrue[m)[42;5H[34m# ÂõõËàç‰∫îÂÖ•Âà∞‰∏áÂàÜ‰Ωç[m
    df = df.[36mround[m([31m4[m)
    [34m# ËøáÊª§ÊéâËøáÂ∞èÁöÑ‰ªΩÈ¢ù[m
    df[df.[36mabs[m() < [31m0.0009999[m] = [31m0[m
    [34m# Ë°•Ë∂≥Áº∫Â§±[m
    df = df.[36mapply[m(npu.np_pad_to, raw=[36mTrue[m, axis=[31m1[m)
    [34m# ËøáÊª§ÊéâÁõ∏Âêå[m
    df = df.groupby(level=([31m0[m,[31m1[m), group_keys=[36mFalse[m).[36mapply[m(DFUtil.filter_same_with_last)[51;5Hdf.columns.name=[31m'rm_asset'[m
    df_tosave = df.stack().to_frame([31m'rm_ratio'[m)
    df_tosave = df_tosave.loc[df_tosave[[31m'rm_ratio'[m] > [31m0[m, [[31m'rm_ratio'[m]]
    [33mif[m [33mnot[m df_tosave.empty:[55;9Hdatabase.number_format(df_tosave, columns=[[31m'rm_ratio'[m], precision=[31m4[m)[57;5Hdf_tosave[[31m'updated_at'[m] = df_tosave[[31m'created_at'[m] = now[59;5Hdf_tosave.to_sql(rm_risk_mgr_pos.name, db, index=[36mTrue[m, if_exists=[31m'append'[m, chunksize=[31m500[m)[61;5H[33mif[m [36mlen[m(df_tosave.index) > [31m1[m:[62;9Hlogger.info([31m"insert %s (%5d) : %s "[m % (rm_risk_mgr_pos.name, [36mlen[m(df_tosave.index), df_tosave.index[[31m0[m]))[64;168H[K[64;168H313,5[9C47%[34;5H[?12l[?25h[?25l[1;63r[1;1H[31M[1;64r[33;5Hclick.echo(click.style([31m"import complement! instance id [%s]"[m % (optid), fg=[31m'green'[m))[35;5H[33mreturn[m [31m0[m

[35m@[m[36mriskmgr.command[m()
[35m@[m[36mclick.option[m([31m'--id'[m, [31m'optid'[m, [36mhelp[m=[31m'risk mgr id'[m)
[35m@[m[36mclick.option[m([31m'--list/--no-list'[m, [31m'optlist'[m, default=[36mFalse[m, [36mhelp[m=[31m'list pool to update'[m)
[35m@[m[36mclick.pass_context[m
[33mdef[m [36mcalc_vars[m(ctx, optid, optlist):
    [31m'''calculate VaRs
    '''[m
    [33mif[m optid [33mis[m [33mnot[m [36mNone[m:[45;9Hids = [s.strip() [33mfor[m s [33min[m optid.split([31m','[m)]
    [33melse[m:[47;9Hids = [36mNone[m[49;5Hxtypes = [36mNone[m[51;5Hdf_riskmgr = asset_rm_riskmgr.load(ids, xtypes)[53;5H[33mif[m optlist:[54;9Hdf_riskmgr[[31m'rm_name'[m] = df_riskmgr[[31m'rm_name'[m].[36mmap[m([33mlambda[m e: e.decode([31m'utf-8'[m))[55;9H[36mprint[m(tabulate(df_riskmgr, headers=[31m'keys'[m, tablefmt=[31m'psql'[m))[56;9H[33mreturn[m [31m0[m[58;5H[34m# with click.progressbar(length=len(df_riskmgr), label='update riskmgr signal') as bar:
[m    [34m#     for _, riskmgr in df_riskmgr.iterrows():
[m    [34m#         bar.update(1)
[m    [34m#         signal_update(riskmgr)[m
    [33mfor[m _, riskmgr [33min[m df_riskmgr.iterrows():[63;9H[33mif[m riskmgr[[31m'rm_algo'[m] == [31m4[m [33mor[m riskmgr[[31m'rm_algo'[m] == [31m5[m:[64;168H[K[64;168H344,0-1[7C52%[34;1H[?12l[?25h[?25l[1;63r[1;1H[31M[1;64r[33;13Hvars_update(riskmgr)[34;9H[33melse[m:[35;13H[33mpass


def[m [36mvars_update[m(riskmgr):
    riskmgr_id = riskmgr[[31m'globalid'[m]
    rm_start_date = pd.to_datetime(riskmgr[[31m'rm_start_date'[m])[42;5Hargv = [36mdict[m()
    [34m#Parse argv by json.[m
    [33mif[m riskmgr[[31m'rm_argv'[m] != [31m''[m:[45;9Hargv.update({k: json.loads(v) [33mfor[m (k,v) [33min[m [x.split([31m'='[m) [33mfor[m x [33min[m riskmgr[[31m'rm_argv'[m].split([31m';'[m)]})[47;5H[33mif[m riskmgr[[31m'rm_algo'[m] == [31m4[m:[48;9H[34m#Univariate GARCH[m[49;9Hcodes = [riskmgr[[31m'rm_asset_id'[m]][51;5H[33mif[m riskmgr[[31m'rm_algo'[m] == [31m5[m:[52;9H[34m#Multivariate GARCH[53;9H#In this case, we concern others assets that will involve into multivarate distribution fitting.[m[54;9Htmp_df_riskmgrs = asset_rm_riskmgr.load(argv[[31m'assets'[m])[55;9Htmp_df_riskmgrs = tmp_df_riskmgrs.append(riskmgr)[56;9Hcodes = [row[[31m'rm_asset_id'[m] [33mfor[m _, row [33min[m tmp_df_riskmgrs.iterrows()][59;5HVaR = RiskMgrVaRs.RiskMgrVaRs()
    [34m#Load datas from DB[m
    tdates = {_id: base_trade_dates.load_origin_index_trade_date(_id) [33mfor[m _id [33min[m codes}
    vars_ = {_id: asset_rm_riskmgr_vars.load_series(_id) [33mfor[m _id [33min[m codes}
    [33mfor[m _id [33min[m codes:[64;168H[K[64;168H375,9[9C57%[34;9H[?12l[?25h[?25l[1;63r[1;1H[31M[1;64r[33;9Htdate = tdates[_id][34;9Htdate = tdate[tdate >= rm_start_date] [33mif[m rm_start_date [33mis[m [33mnot[m [36mNone[m [33melse[m tdate[35;9H[34m# Check if the VaRs table is empty[m[36;9H[33mif[m vars_[_id].empty:[37;13Hnav = database.load_nav_series(_id, reindex=tdate)[38;13Hdf_vars = VaR.perform(nav)[39;9H[33melse[m:[40;13H[34m#If not empty, check if it needs to update[m[41;13Hdf_vars = vars_[_id][42;13Hmissing_days = tdate[[31m600[m:].difference(df_vars.index)[43;13H[33mif[m missing_days.empty:[44;17H[33mcontinue[45;13Helse[m:[46;17Hnav = database.load_nav_series(_id, reindex=tdate)[47;17Hidxs = [i [33mfor[m i [33min[m [36mrange[m([31m600[m, [36mlen[m(tdate)) [33mif[m tdate[i] [33min[m missing_days][48;17H[34m#  idxs = filter(lambda i: tdate[i] in missing_days, range(600, len(tdate)))[m[49;17Hdf_tmp = VaR.perform_days(nav, idxs)[50;17Hdf_vars = pd.concat([df_vars, df_tmp])[51;9Hdf_vars.index.name = [31m'ix_date'[m[52;9Hdf_vars[[31m'index_id'[m] = _id[53;9Hdf_tosave = df_vars.reset_index().set_index([[31m'index_id'[m, [31m'ix_date'[m])[54;9Hasset_rm_riskmgr_vars.save(_id, df_tosave)
    [33mif[m riskmgr[[31m'rm_algo'[m] == [31m5[m:[56;9Hmgarch_update(tmp_df_riskmgrs, riskmgr_id, tdates)


[33mdef[m [36mmgarch_update[m(riskmgr, target, _tdates):
    Joint = RiskMgrVaRs.RiskMgrJoint()
    codes = {row[[31m'globalid'[m]:row[[31m'rm_asset_id'[m] [33mfor[m _, row [33min[m riskmgr.iterrows()}
    tdates = {global_id: _tdates[asset_id] [33mfor[m global_id, asset_id [33min[m [36mlist[m(codes.items())}
    [34m#filter tradedays by target asset[m[64;168H[K[64;168H406,9[9C63%[34;9H[?12l[?25h[?25l[1;63r[1;1H[31M[1;64r[33;5H[33mfor[m i [33min[m codes:[34;9H[33mif[m i != target:[35;13Htdates[i] = tdates[target].intersection(tdates[i])
    df_joint = asset_rm_riskmgr_mgarch_signal.load_series(target)
    [34m#check if the table loaded from db is empty[m
    [33mif[m df_joint.empty:[39;9Hdf_nav = pd.DataFrame({global_id: database.load_nav_series(asset_id, reindex=tdates[global_id]) [33mfor[m global_id, asset_id [33min[m [36mlist[m(codes.items())})[40;9Hdf_joint = Joint.perform(df_nav, target)
    [33melse[m:[42;9H[34m#since the table is not empty, check if the table above needs update.[m[43;9Hmissing_days = tdates[target].difference(df_joint.index)[44;9H[33mif[m missing_days.empty:[45;13H[33mreturn[m [36mNone[m[46;9H[33melse[m:[47;13Hdf_nav = pd.DataFrame({global_id: database.load_nav_series(asset_id, reindex=tdates[global_id]) [33mfor[m global_id, asset_id [33min[m [36mlist[m(codes.items())})[48;13Hdf_tmp = Joint.perform_days(df_nav, target, missing_days)[49;13Hdf_joint = pd.concat([df_joint, df_tmp])
    df_joint = df_joint.reindex(tdates[target]).fillna([31m0[m)
    df_joint.columns.name = [31m'target_rm_riskmgr_id'[m
    df_joint.index.name=[31m'rm_date'[m
    df_joint[[31m'rm_riskmgr_id'[m] = target
    df_joint = df_joint.reset_index().set_index([[31m'rm_riskmgr_id'[m, [31m'rm_date'[m])
    df_joint = df_joint.stack().to_frame()
    df_joint.columns = [[31m'rm_signal'[m]
    asset_rm_riskmgr_mgarch_signal.save(target, df_joint)


[35m@[m[36mriskmgr.command[m()
[35m@[m[36mclick.option[m([31m'--id'[m, [31m'optid'[m, [36mhelp[m=[31m'risk mgr id'[m)
[35m@[m[36mclick.option[m([31m'--list/--no-list'[m, [31m'optlist'[m, default=[36mFalse[m, [36mhelp[m=[31m'list pool to update'[m)
[35m@[m[36mclick.option[m([31m'--online/--no-online'[m, [31m'optonline'[m, default=[36mFalse[m, [36mhelp[m=[31m'include online instance'[m)[64;168H[K[64;168H437,9[9C68%[34;9H[?12l[?25h[?25l[1;63r[1;1H[31M[1;64r[33;1H[35m@[m[36mclick.pass_context[m
[33mdef[m [36msignal[m(ctx, optid, optlist, optonline):
    [31m'''run risk management using simple strategy
    '''[m
    [33mif[m optid [33mis[m [33mnot[m [36mNone[m:[38;9Hids = [s.strip() [33mfor[m s [33min[m optid.split([31m','[m)]
    [33melse[m:[40;9Hids = [36mNone[m[42;5Hxtypes = [36mNone[m
    [33mif[m optonline == [36mFalse[m:[44;9Hxtypes = [[31m1[m][46;5Hdf_riskmgr = asset_rm_riskmgr.load(ids, xtypes)[48;5H[33mif[m optlist:[50;9Hdf_riskmgr[[31m'rm_name'[m] = df_riskmgr[[31m'rm_name'[m].[36mmap[m([33mlambda[m e: e.decode([31m'utf-8'[m))[51;9H[36mprint[m(tabulate(df_riskmgr, headers=[31m'keys'[m, tablefmt=[31m'psql'[m))[52;9H[33mreturn[m [31m0[m[54;5H[34m# with click.progressbar(length=len(df_riskmgr), label='update riskmgr signal') as bar:
[m    [34m#     for _, riskmgr in df_riskmgr.iterrows():
[m    [34m#         bar.update(1)
[m    [34m#         signal_update(riskmgr)[m
    [33mfor[m _, riskmgr [33min[m df_riskmgr.iterrows():[59;9H[33mif[m riskmgr[[31m'rm_algo'[m] == [31m4[m [33mor[m riskmgr[[31m'rm_algo'[m] == [31m5[m:[60;13Hsignal_update_garch(riskmgr)[61;9H[33melse[m:[62;13Hsignal_update(riskmgr)[64;168H[K[64;168H468,1[9C73%[34;1H[?12l[?25h[?25l[1;63r[1;1H[31M[1;64r[33;1H[33mdef[m [36msignal_update[m(riskmgr):
    riskmgr_id = riskmgr[[31m'globalid'[m][36;5Hargv = {[31m'e'[m: [31m5[m}
    [33mif[m riskmgr[[31m'rm_argv'[m] != [31m''[m:[38;9Hargv.update({k: [36mint[m(v) [33mfor[m (k,v) [33min[m [x.split([31m'='[m) [33mfor[m x [33min[m riskmgr[[31m'rm_argv'[m].split([31m','[m)]})[40;5H[34m# Âä†ËΩΩÊã©Êó∂‰ø°Âè∑[m
    sr_timing = asset_tc_timing_signal.load_series(riskmgr[[31m'rm_timing_id'[m])
    [34m# print sr_timing.head()[m
    [33mif[m sr_timing.empty:[44;9Hclick.echo(click.style([31m"[m[35m\n[m[31mempty timing signal (%s, %s), suppose all 1[m[35m\n[m[31m"[m % (riskmgr_id, riskmgr[[31m'rm_timing_id'[m]), fg=[31m"red"[m))[46;5H[34m# Âä†ËΩΩËµÑ‰∫ßÊî∂ÁõäÁéá
[m    [34m# min_date = df_position.index.min()
[m    [34m# max_date = (datetime.now() - timedelta(days=1)) # yesterday[m[50;5H[33mif[m riskmgr[[31m'rm_start_date'[m] != [31m'0000-00-00'[m:[51;9Hsdate = riskmgr[[31m'rm_start_date'[m]
    [33melse[m:[53;9Hsdate = [36mNone[m[55;5H[34m#tdates = base_trade_dates.load_other_index(riskmgr['rm_asset_id'], sdate)[m
    tdates = base_trade_dates.load_origin_index_trade_date(riskmgr[[31m'rm_asset_id'[m], sdate)
    sr_nav = database.load_nav_series(riskmgr[[31m'rm_asset_id'[m], reindex=tdates, begin_date=sdate)[59;5H[33mif[m sr_timing.empty:[60;9Hsr_timing = pd.Series([31m1[m, index=sr_nav.index)[62;5Hdf = pd.DataFrame({[31m'nav'[m: sr_nav, [31m'timing'[m: sr_timing})[64;168H[K[64;168H499,5[9C78%[34;5H[?12l[?25h[?25l[1;63r[1;1H[31M[1;64r[33;5H[33mif[m riskmgr[[31m'rm_algo'[m] == [31m1[m:[34;9Hrisk_mgr = RiskManagement.RiskManagement()
    [33melif[m riskmgr[[31m'rm_algo'[m] == [31m2[m:[36;9Hrisk_mgr = RiskMgrSimple.RiskMgrSimple(empty=argv[[31m'e'[m])
    [33melif[m riskmgr[[31m'rm_algo'[m] == [31m3[m:[38;9Hrisk_mgr = RiskMgrLow.RiskMgrLow()
    [33melse[m:[40;9Hclick.echo(click.style([31m"[m[35m\n[m[31munsupported riskmgr algo (%s, %s)[m[35m\n[m[31m"[m % (riskmgr_id, riskmgr[[31m'rm_algo'[m]), fg=[31m"red"[m))[41;9H[33mreturn[m [36mFalse[m[43;5Hdf_result = risk_mgr.perform(riskmgr_id, df)
    [34m# df_result.drop(['nav', 'timing'], axis=1, inplace=True)[m
    df_result = DFUtil.filter_same_with_last(df_result)[47;5H[34m# df_result = df_nav_portfolio[['portfolio']].rename(columns={'portfolio':'rm_nav'}).copy()[m
    df_result.index.name = [31m'rm_date'[m
    df_result[[31m'rm_riskmgr_id'[m] = riskmgr_id
    df_tosave = df_result.reset_index().set_index([[31m'rm_riskmgr_id'[m, [31m'rm_date'[m])[52;5Hasset_rm_riskmgr_signal.save(riskmgr_id, df_tosave)


[33mdef[m [36msignal_update_garch[m(riskmgr):
    riskmgr_id = riskmgr[[31m'globalid'[m]
    argv = [36mdict[m()
    [34m#Parse argvs[m
    [33mif[m riskmgr[[31m'rm_argv'[m] != [31m''[m:[60;9Hargv.update({k: json.loads(v) [33mfor[m (k,v) [33min[m [x.split([31m'='[m) [33mfor[m x [33min[m riskmgr[[31m'rm_argv'[m].split([31m';'[m)]})[62;5H[33mif[m riskmgr[[31m'rm_algo'[m] == [31m4[m:[63;9H[34m#Univariate GARCH[m[64;168H[K[64;168H530,9[9C84%[34;9H[?12l[?25h[?25l[1;63r[1;1H[31M[1;64r[33;9Hcodes = {riskmgr[[31m'globalid'[m] : {[31m"id"[m : riskmgr[[31m'rm_asset_id'[m], [31m"timing"[m : riskmgr[[31m'rm_timing_id'[m]}}[35;5H[33mif[m riskmgr[[31m'rm_algo'[m] == [31m5[m:[36;9H[34m#Multivariate GARCH[m[37;9Htmp_df_riskmgrs = asset_rm_riskmgr.load(argv[[31m'assets'[m])[38;9Htmp_df_riskmgrs = tmp_df_riskmgrs.append(riskmgr)[39;9Hcodes = {}[40;9H[33mfor[m _, row [33min[m tmp_df_riskmgrs.iterrows():[41;13Hcodes[row[[31m'globalid'[m]] = {[31m"id"[m : row[[31m'rm_asset_id'[m], [31m"timing"[m : row[[31m'rm_timing_id'[m]}[43;5Htarget = riskmgr_id[45;5H[34m#Load datas from DB[m
    tdates = {k: base_trade_dates.load_origin_index_trade_date(v[[31m'id'[m]) [33mfor[m k, v [33min[m [36mlist[m(codes.items())}
    [34m#For each other assets, filter the tradedates by the target one
[m    [34m# for i in codes:
[m    [34m#     if i != target:
[m    [34m#         tdates[i] = tdates[target].intersection(tdates[i])[m
    df_nav = pd.DataFrame({k: database.load_nav_series(v[[31m'id'[m], reindex=tdates[k]) [33mfor[m k, v [33min[m [36mlist[m(codes.items())})
    timing = pd.DataFrame({k: asset_tc_timing_signal.load_series(v[[31m'timing'[m]).reindex(tdates[k]) [33mfor[m k,v [33min[m [36mlist[m(codes.items())})
    vars_ = {k: asset_rm_riskmgr_vars.load_series(v[[31m'id'[m]) [33mfor[m k,v [33min[m [36mlist[m(codes.items())}[55;5H[33mif[m riskmgr[[31m'rm_algo'[m] == [31m4[m:[56;9Hrisk_mgr = RiskMgrGARCH.RiskMgrGARCH(codes, target, tdates, df_nav, timing, vars_)
    [33melif[m riskmgr[[31m'rm_algo'[m] == [31m5[m:[58;9Hothers = [k [33mfor[m k [33min[m codes [33mif[m k != target][59;9Hjoint = asset_rm_riskmgr_mgarch_signal.load_series(riskmgr_id).loc[:, others][60;9Hrisk_mgr = RiskMgrGARCH.RiskMgrMGARCH(codes, target, tdates, df_nav, timing, vars_, joint)[62;5Hdf_result = risk_mgr.perform()
    df_result = df_result.drop([[31m'rm_status'[m], axis=[31m1[m)[64;168H[K[64;168H561,0-1[7C89%[34;1H[?12l[?25h[?25l[1;63r[1;1H[31M[1;64r[33;5Hdf_result = DFUtil.filter_same_with_last(df_result)[35;5H[34m# df_result = df_nav_portfolio[['portfolio']].rename(columns={'portfolio':'rm_nav'}).copy()[m
    df_result.index.name = [31m'rm_date'[m
    df_result[[31m'rm_riskmgr_id'[m] = riskmgr_id
    df_tosave = df_result.reset_index().set_index([[31m'rm_riskmgr_id'[m, [31m'rm_date'[m])[40;5Hasset_rm_riskmgr_signal.save(riskmgr_id, df_tosave)

[35m@[m[36mriskmgr.command[m()
[35m@[m[36mclick.option[m([31m'--id'[m, [31m'optid'[m, [36mhelp[m=[31m'ids of fund pool to update'[m)
[35m@[m[36mclick.option[m([31m'--list/--no-list'[m, [31m'optlist'[m, default=[36mFalse[m, [36mhelp[m=[31m'list pool to update'[m)
[35m@[m[36mclick.pass_context[m
[33mdef[m [36mnav[m(ctx, optid, optlist):
    [31m''' calc riskmgr nav and inc
    '''[m
    [33mif[m optid [33mis[m [33mnot[m [36mNone[m:[50;9Hids = [s.strip() [33mfor[m s [33min[m optid.split([31m','[m)]
    [33melse[m:[52;9Hids = [36mNone[m[54;5Hdf_riskmgr = asset_rm_riskmgr.load(ids)[56;5H[33mif[m optlist:[58;9Hdf_riskmgr[[31m'rm_name'[m] = df_riskmgr[[31m'rm_name'[m].[36mmap[m([33mlambda[m e: e.decode([31m'utf-8'[m))[59;9H[36mprint[m(tabulate(df_riskmgr, headers=[31m'keys'[m, tablefmt=[31m'psql'[m))[60;9H[33mreturn[m [31m0[m[62;5H[33mwith[m click.progressbar(length=[36mlen[m(df_riskmgr), label=[31m'update nav'[m.ljust([31m30[m)) [33mas[m bar:[63;9H[33mfor[m _, riskmgr [33min[m df_riskmgr.iterrows():[64;168H[K[64;168H592,0-1[7C94%[34;1H[?12l[?25h[?25l[1;63r[1;1H[31M[1;64r[33;13Hbar.update([31m1[m)[34;13Hnav_update(riskmgr)

[33mdef[m [36mnav_update[m(riskmgr):
    riskmgr_id = riskmgr[[31m'globalid'[m]
    [34m# Âä†ËΩΩÊã©Êó∂‰ø°Âè∑[m
    sr_position = asset_rm_riskmgr_signal.load_series(riskmgr_id)
    [33mif[m sr_position.empty:[41;9H[33mreturn[m
    df_position = sr_position.to_frame(riskmgr_id)[44;5H[34m# Âä†ËΩΩÂü∫ÈáëÊî∂ÁõäÁéá[m
    min_date = df_position.index.[36mmin[m()
    [34m#max_date = df_position.index.max()[m
    max_date = (datetime.now() - timedelta(days=[31m1[m)) [34m# yesterday[m[50;5Hsr_nav = database.load_nav_series([51;9Hriskmgr[[31m'rm_asset_id'[m], begin_date=min_date, end_date=max_date)
    df_inc = sr_nav.pct_change().fillna([31m0.0[m).to_frame(riskmgr_id)[54;5H[34m# ËÆ°ÁÆóÂ§çÂêàËµÑ‰∫ßÂáÄÂÄº[m
    df_nav_portfolio = DFUtil.portfolio_nav(df_inc, df_position, result_col=[31m'portfolio'[m)[57;5Hdf_result = df_nav_portfolio[[[31m'portfolio'[m]].rename(columns={[31m'portfolio'[m:[31m'rm_nav'[m}).copy()
    df_result.index.name = [31m'rm_date'[m
    df_result[[31m'rm_inc'[m] = df_result[[31m'rm_nav'[m].pct_change().fillna([31m0.0[m)
    df_result[[31m'rm_riskmgr_id'[m] = riskmgr_id
    df_result = df_result.reset_index().set_index([[31m'rm_riskmgr_id'[m, [31m'rm_date'[m])[63;5Hasset_rm_riskmgr_nav.save(riskmgr_id, df_result)[64;168H[K[64;168H623,13[8C99%[34;13H[?12l[?25h[?25l[1;63r[63;1H
[1;64r[64;168H[K[64;168H653,0-1[7CBot[63;1H[?12l[?25h[?25l[64;170H2,1  [62;1H[?12l[?25h[?25l[64;170H1,0-1[61;1H[?12l[?25h[?25l[64;170H0,1  [60;1H[?12l[?25h[?25l[64;169H49[59;1H[?12l[?25h[?25l[64;170H8[58;1H[?12l[?25h[?25l[64;170H7[57;1H[?12l[?25h[?25l[64;170H6[56;1H[?12l[?25h[?25l[64;170H5,0-1[55;1H[?12l[?25h[?25l[64;170H4,1  [54;1H[?12l[?25h[?25l[64;170H3[53;1H[?12l[?25h[?25l[64;170H2,0-1[52;1H[?12l[?25h[?25l[64;170H1,1  [51;1H[?12l[?25h[?25l[64;170H0[50;1H[?12l[?25h[?25l[64;169H39[49;1H[?12l[?25h[?25l[64;170H8,0-1[48;1H[?12l[?25h[?25l[64;170H7[47;1H[?12l[?25h[?25l[64;170H6,1  [46;1H[?12l[?25h[?25l[64;170H5[45;1H[?12l[?25h[?25l[64;170H4[44;1H[?12l[?25h[?25l[64;170H3[43;1H[?12l[?25h[?25l[64;170H2,0-1[42;1H[?12l[?25h[?25l[64;170H1,1  [41;1H[?12l[?25h[?25l[64;170H0[40;1H[?12l[?25h[?25l[64;169H29[39;1H[?12l[?25h[?25l[64;170H8[38;1H[?12l[?25h[?25l[64;170H7[37;1H[?12l[?25h[?25l[64;170H6[36;1H[?12l[?25h[?25l[64;170H5[35;1H[?12l[?25h[?25l[64;170H4,0-1[34;1H[?12l[?25h[?25l[64;170H3,1  [33;1H[?12l[?25h[?25l[64;170H2[32;1H[?12l[?25h[?25l[64;170H1[31;1H[?12l[?25h[?25l[64;170H0[30;1H[?12l[?25h[?25l[64;169H19,0-1[29;1H[?12l[?25h[?25l[64;170H8,1  [28;1H[?12l[?25h[?25l[64;170H7[27;1H[?12l[?25h[?25l[64;170H6[26;1H[?12l[?25h[?25l[64;170H5,0-1[25;1H[?12l[?25h[?25l[64;170H4,1  [24;1H[?12l[?25h[?25l[64;170H3,0-1[23;1H[?12l[?25h[?25l[64;170H2,1  [22;1H[?12l[?25h[?25l[64;170H1,0-1[21;1H[?12l[?25h[?25l[64;170H0,1  [20;1H[?12l[?25h[?25l[64;169H09[19;1H[?12l[?25h[?25l[64;170H8[18;1H[?12l[?25h[?25l[64;170H7[17;1H[?12l[?25h[?25l[64;170H6[16;1H[?12l[?25h[?25l[64;170H5[15;1H[?12l[?25h[?25l[64;170H4[14;1H[?12l[?25h[?25l[64;170H3[13;1H[?12l[?25h[?25l[64;170H2[12;1H[?12l[?25h[?25l[64;170H3[13;1H[?12l[?25h[?25l[64;170H4[14;1H[?12l[?25h[?25l[64;170H5[15;1H[?12l[?25h[?25l[64;170H6[16;1H[?12l[?25h[?25l[64;170H7[17;1H[?12l[?25h[?25l[64;170H8[18;1H[?12l[?25h[?25l[64;170H9[19;1H[?12l[?25h[?25l[64;169H10[20;1H[?12l[?25h[?25l[64;170H1,0-1[21;1H[?12l[?25h[?25l[64;170H2,1  [22;1H[?12l[?25h[?25l[64;170H3,0-1[23;1H[?12l[?25h[?25l[64;170H4,1  [24;1H[?12l[?25h[?25l[64;170H5,0-1[25;1H[?12l[?25h[?25l[64;170H6,1  [26;1H[?12l[?25h[?25l[64;170H7[27;1H[?12l[?25h[?25l[64;170H8[28;1H[?12l[?25h[?25l[64;170H9,0-1[29;1H[?12l[?25h[?25l[64;169H20,1  [30;1H[?12l[?25h[?25l[64;170H1[31;1H[?12l[?25h[?25l[64;170H2[32;1H[?12l[?25h[?25l[64;170H3[33;1H[?12l[?25h[?25l[64;170H4,0-1[34;1H[?12l[?25h[?25l[64;170H5,1  [35;1H[?12l[?25h[?25l[64;170H6[36;1H[?12l[?25h[?25l[64;170H7[37;1H[?12l[?25h[?25l[64;170H8[38;1H[?12l[?25h[?25l[64;170H9[39;1H[?12l[?25h[?25l[64;169H30[40;1H[?12l[?25h[?25l[64;170H1[41;1H[?12l[?25h[?25l[64;170H2,0-1[42;1H[?12l[?25h[?25l[64;170H3,1  [43;1H[?12l[?25h[?25l[64;170H4[44;1H[?12l[?25h[?25l[64;170H5[45;1H[?12l[?25h[?25l[64;170H6[46;1H[?12l[?25h[?25l[64;170H7,0-1[47;1H[?12l[?25h[?25l[64;170H8[48;1H[?12l[?25h[?25l[64;170H9,1  [49;1H[?12l[?25h[?25l[64;169H40[50;1H[?12l[?25h[?25l[64;170H1[51;1H[?12l[?25h[?25l[64;170H2,0-1[52;1H[?12l[?25h[?25l[64;170H3,1  [53;1H[?12l[?25h[?25l[64;170H4[54;1H[?12l[?25h[?25l[64;170H5,0-1[55;1H[?12l[?25h[?25l[64;170H6,1  [56;1H[?12l[?25h[?25l[64;170H7[57;1H[?12l[?25h[?25l[64;170H8[58;1H[?12l[?25h[?25l[64;170H9[59;1H[?12l[?25h[?25l[64;169H50[60;1H[?12l[?25h[?25l[64;170H1,0-1[61;1H[?12l[?25h[?25l[64;170H2,1  [62;1H[?12l[?25h[?25l[64;170H3,0-1[63;1H[?12l[?25h

[?1l>[?1049l
[1]+  Stopped                 vim shell/CommandRiskManage.py
]0;bae@fd3d2f0db4d6:~/recommend_model/asset_allocation_v2[bae@fd3d2f0db4d6 asset_allocation_v2]$ vi: RiskMgrGARCHHelpoer[K[K[Ker.py
bash: vi:: command not found
]0;bae@fd3d2f0db4d6:~/recommend_model/asset_allocation_v2[bae@fd3d2f0db4d6 asset_allocation_v2]$ vi Risk [KMgrGarchH[K[K[K[K[KARCHHE[Kelper.py
[?1049h[?1h=[2;1H‚ñΩ[6n[1;1H  [1;1H[1;64r[?12;25h[?12l[?25h[27m[m[H[2J[?25l[64;1H"RiskMgrGARCHHelper.py" [New File][>c[2;1H[1m[34m~                                                                                                                                                                                        [3;1H~                                                                                                                                                                                        [4;1H~                                                                                                                                                                                        [5;1H~                                                                                                                                                                                        [6;1H~                                                                                                                                                                                        [7;1H~                                                                                                                                                                                        [8;1H~                                                                                                                                                                                        [9;1H~                                                                                                                                                                                        [10;1H~                                                                                                                                                                                        [11;1H~                                                                                                                                                                                        [12;1H~                                                                                                                                                                                        [13;1H~                                                                                                                                                                                        [14;1H~                                                                                                                                                                                        [15;1H~                                                                                                                                                                                        [16;1H~                                                                                                                                                                                        [17;1H~                                                                                                                                                                                        [18;1H~                                                                                                                                                                                        [19;1H~                                                                                                                                                                                        [20;1H~                                                                                                                                                                                        [21;1H~                                                                                                                                                                                        [22;1H~                                                                                                                                                                                        [23;1H~                                                                                                                                                                                        [24;1H~                                                                                                                                                                                        [25;1H~                                                                                                                                                                                        [26;1H~                                                                                                                                                                                        [27;1H~                                                                                                                                                                                        [28;1H~                                                                                                                                                                                        [29;1H~                                                                                                                                                                                        [30;1H~                                                                                                                                                                                        [31;1H~                                                                                                                                                                                        [32;1H~                                                                                                                                                                                        [33;1H~                                                                                                                                                                                        [34;1H~                                                                                                                                                                                        [35;1H~                                                                                                                                                                                        [36;1H~                                                                                                                                                                                        [37;1H~                                                                                                                                                                                        [38;1H~                                                                                                                                                                                        [39;1H~                                                                                                                                                                                        [40;1H~                                                                                                                                                                                        [41;1H~                                                                                                                                                                                        [42;1H~                                                                                                                                                                                        [43;1H~                                                                                                                                                                                        [44;1H~                                                                                                                                                                                        [45;1H~                                                                                                                                                                                        [46;1H~                                                                                                                                                                                        [47;1H~                                                                                                                                                                                        [48;1H~                                                                                                                                                                                        [49;1H~                                                                                                                                                                                        [50;1H~                                                                                                                                                                                        [51;1H~                                                                                                                                                                                        [52;1H~                                                                                                                                                                                        [53;1H~                                                                                                                                                                                        [54;1H~                                                                                                                                                                                        [55;1H~                                                                                                                                                                                        [56;1H~                                                                                                                                                                                        [57;1H~                                                                                                                                                                                        [58;1H~                                                                                                                                                                                        [59;1H~                                                                                                                                                                                        [60;1H~                                                                                                                                                                                        [61;1H~                                                                                                                                                                                        [62;1H~                                                                                                                                                                                        [63;1H~                                                                                                                                                                                        [m[64;168H0,0-1[9CAll[1;1H[?12l[?25h[64;1H
[?1l>[?1049l
[2]+  Stopped                 vim RiskMgrGARCHHelper.py
]0;bae@fd3d2f0db4d6:~/recommend_model/asset_allocation_v2[bae@fd3d2f0db4d6 asset_allocation_v2]$ cd[K[KRiskM[K[K[K[K[Kvi RiskMgrGARCHHelper.py[C[1P RiskMgrGARCHHelper.py[1P RiskMgrGARCHHelper.py
bash: RiskMgrGARCHHelper.py: command not found
]0;bae@fd3d2f0db4d6:~/recommend_model/asset_allocation_v2[bae@fd3d2f0db4d6 asset_allocation_v2]$  RiskMgrGARCHHelper.pyV RiskMgrGARCHHelper.pyI RiskMgrGARCHHelper.py[1P RiskMgrGARCHHelper.py[1P RiskMgrGARCHHelper.pyv RiskMgrGARCHHelper.pyi RiskMgrGARCHHelper.py[C RiskMgrGARCHHelper.py
[?1049h[?1h=[2;1H‚ñΩ[6n[1;1H  [1;1H[1;64r[?12;25h[?12l[?25h[27m[m[H[2J[?25l[64;1HE325: ATTENTION
Found a swap file by the name ".RiskMgrGARCHHelper.py.swp"
[10Cowned by: bae   dated: Thu Nov  8 10:26:30 2018
[9Cfile name: ~bae/recommend_model/asset_allocation_v2/RiskMgrGARCHHelper.py
[10Cmodified: no
[9Cuser name: bae   host name: fd3d2f0db4d6
[8Cprocess ID: 1252 (still running)
While opening file "RiskMgrGARCHHelper.py"

(1) Another program may be editing the same file.  If this is the case,
    be careful not to end up with two different instances of the same
    file when making changes.  Quit, or continue with caution.
(2) An edit session for this file crashed.
    If this is the case, use ":recover" or "vim -r RiskMgrGARCHHelper.py"
    to recover the changes (see ":help recovery").
    If you did this already, delete the swap file ".RiskMgrGARCHHelper.py.swp"
    to avoid this message.

Swap file ".RiskMgrGARCHHelper.py.swp" already exists!
[O]pen Read-Only, (E)dit anyway, (R)ecover, (Q)uit, (A)bort:[?12l[?25h[64;1H[K[?25l[64;1H"RiskMgrGARCHHelper.py" [New File]
Using swap file ".RiskMgrGARCHHelper.py.swp"
Original file "~/recommend_model/asset_allocation_v2/RiskMgrGARCHHelper.py"
[63;1H"~/recommend_model/asset_allocation_v2/RiskMgrGARCHHelper.py" [New File][63;73H[K[64;1HRecovery completed. Buffer contents equals file contents.
You may want to delete the .swp file now.


[>cPress ENTER or type command to continue[?12l[?25h[1;1H[7L[?25l[2;1H[1m[34m~                                                                                                                                                                                        [3;1H~                                                                                                                                                                                        [4;1H~                                                                                                                                                                                        [5;1H~                                                                                                                                                                                        [6;1H~                                                                                                                                                                                        [7;1H~                                                                                                                                                                                        [8;1H~                                                                                                                                                                                        [9;1H~                                                                                                                                                                                        [10;1H~                                                                                                                                                                                        [11;1H~                                                                                                                                                                                        [12;1H~                                                                                                                                                                                        [13;1H~                                                                                                                                                                                        [14;1H~                                                                                                                                                                                        [15;1H~                                                                                                                                                                                        [16;1H~                                                                                                                                                                                        [17;1H~                                                                                                                                                                                        [18;1H~                                                                                                                                                                                        [19;1H~                                                                                                                                                                                        [20;1H~                                                                                                                                                                                        [21;1H~                                                                                                                                                                                        [22;1H~                                                                                                                                                                                        [23;1H~                                                                                                                                                                                        [24;1H~                                                                                                                                                                                        [25;1H~                                                                                                                                                                                        [26;1H~                                                                                                                                                                                        [27;1H~                                                                                                                                                                                        [28;1H~                                                                                                                                                                                        [29;1H~                                                                                                                                                                                        [30;1H~                                                                                                                                                                                        [31;1H~                                                                                                                                                                                        [32;1H~                                                                                                                                                                                        [33;1H~                                                                                                                                                                                        [34;1H~                                                                                                                                                                                        [35;1H~                                                                                                                                                                                        [36;1H~                                                                                                                                                                                        [37;1H~                                                                                                                                                                                        [38;1H~                                                                                                                                                                                        [39;1H~                                                                                                                                                                                        [40;1H~                                                                                                                                                                                        [41;1H~                                                                                                                                                                                        [42;1H~                                                                                                                                                                                        [43;1H~                                                                                                                                                                                        [44;1H~                                                                                                                                                                                        [45;1H~                                                                                                                                                                                        [46;1H~                                                                                                                                                                                        [47;1H~                                                                                                                                                                                        [48;1H~                                                                                                                                                                                        [49;1H~                                                                                                                                                                                        [50;1H~                                                                                                                                                                                        [51;1H~                                                                                                                                                                                        [52;1H~                                                                                                                                                                                        [53;1H~                                                                                                                                                                                        [54;1H~                                                                                                                                                                                        [55;1H~                                                                                                                                                                                        [56;1H~                                                                                                                                                                                        [57;1H~                                                                                                                                                                                        [58;1H~                                                                                                                                                                                        [59;1H~                                                                                                                                                                                        [60;1H~                                                                                                                                                                                        [61;1H~                                                                                                                                                                                        [62;1H~                                                                                                                                                                                        [63;1H~                                                                                                                                                                                        [m[64;1H[K[64;168H1,0-1[9CAll[1;1H[?12l[?25h[64;1H
[?1l>[?1049l
[3]+  Stopped                 vim RiskMgrGARCHHelper.py
]0;bae@fd3d2f0db4d6:~/recommend_model/asset_allocation_v2[bae@fd3d2f0db4d6 asset_allocation_v2]$ vo[Ko[K[Kvi  RiskMgrGARCHHelper.py
[?1049h[?1h=[2;1H‚ñΩ[6n[1;1H  [1;1H[1;64r[?12;25h[?12l[?25h[27m[m[H[2J[?25l[64;1HE325: ATTENTION
Found a swap file by the name ".RiskMgrGARCHHelper.py.swp"
[10Cowned by: bae   dated: Thu Nov  8 10:26:30 2018
[9Cfile name: ~bae/recommend_model/asset_allocation_v2/RiskMgrGARCHHelper.py
[10Cmodified: no
[9Cuser name: bae   host name: fd3d2f0db4d6
[8Cprocess ID: 1252 (still running)
While opening file "RiskMgrGARCHHelper.py"

(1) Another program may be editing the same file.  If this is the case,
    be careful not to end up with two different instances of the same
    file when making changes.  Quit, or continue with caution.
(2) An edit session for this file crashed.
    If this is the case, use ":recover" or "vim -r RiskMgrGARCHHelper.py"
    to recover the changes (see ":help recovery").
    If you did this already, delete the swap file ".RiskMgrGARCHHelper.py.swp"
    to avoid this message.

Swap file ".RiskMgrGARCHHelper.py.swp" already exists!
[O]pen Read-Only, (E)dit anyway, (R)ecover, (Q)uit, (A)bort:[?12l[?25h[64;1H[K[?25l[64;1H"RiskMgrGARCHHelper.py" [New File][>c[2;1H[1m[34m~                                                                                                                                                                                        [3;1H~                                                                                                                                                                                        [4;1H~                                                                                                                                                                                        [5;1H~                                                                                                                                                                                        [6;1H~                                                                                                                                                                                        [7;1H~                                                                                                                                                                                        [8;1H~                                                                                                                                                                                        [9;1H~                                                                                                                                                                                        [10;1H~                                                                                                                                                                                        [11;1H~                                                                                                                                                                                        [12;1H~                                                                                                                                                                                        [13;1H~                                                                                                                                                                                        [14;1H~                                                                                                                                                                                        [15;1H~                                                                                                                                                                                        [16;1H~                                                                                                                                                                                        [17;1H~                                                                                                                                                                                        [18;1H~                                                                                                                                                                                        [19;1H~                                                                                                                                                                                        [20;1H~                                                                                                                                                                                        [21;1H~                                                                                                                                                                                        [22;1H~                                                                                                                                                                                        [23;1H~                                                                                                                                                                                        [24;1H~                                                                                                                                                                                        [25;1H~                                                                                                                                                                                        [26;1H~                                                                                                                                                                                        [27;1H~                                                                                                                                                                                        [28;1H~                                                                                                                                                                                        [29;1H~                                                                                                                                                                                        [30;1H~                                                                                                                                                                                        [31;1H~                                                                                                                                                                                        [32;1H~                                                                                                                                                                                        [33;1H~                                                                                                                                                                                        [34;1H~                                                                                                                                                                                        [35;1H~                                                                                                                                                                                        [36;1H~                                                                                                                                                                                        [37;1H~                                                                                                                                                                                        [38;1H~                                                                                                                                                                                        [39;1H~                                                                                                                                                                                        [40;1H~                                                                                                                                                                                        [41;1H~                                                                                                                                                                                        [42;1H~                                                                                                                                                                                        [43;1H~                                                                                                                                                                                        [44;1H~                                                                                                                                                                                        [45;1H~                                                                                                                                                                                        [46;1H~                                                                                                                                                                                        [47;1H~                                                                                                                                                                                        [48;1H~                                                                                                                                                                                        [49;1H~                                                                                                                                                                                        [50;1H~                                                                                                                                                                                        [51;1H~                                                                                                                                                                                        [52;1H~                                                                                                                                                                                        [53;1H~                                                                                                                                                                                        [54;1H~                                                                                                                                                                                        [55;1H~                                                                                                                                                                                        [56;1H~                                                                                                                                                                                        [57;1H~                                                                                                                                                                                        [58;1H~                                                                                                                                                                                        [59;1H~                                                                                                                                                                                        [60;1H~                                                                                                                                                                                        [61;1H~                                                                                                                                                                                        [62;1H~                                                                                                                                                                                        [63;1H~                                                                                                                                                                                        [m[64;168H0,0-1[9CAll[1;1H[?12l[?25h[64;1H
[?1l>[?1049l
[4]+  Stopped                 vim RiskMgrGARCHHelper.py
]0;bae@fd3d2f0db4d6:~/recommend_model/asset_allocation_v2[bae@fd3d2f0db4d6 asset_allocation_v2]$ Vi[K[Kvi  RiskMgrGARCHHelper.py
[?1049h[?1h=[2;1H‚ñΩ[6n[1;1H  [1;1H[1;64r[?12;25h[?12l[?25h[27m[m[H[2J[?25l[64;1HE325: ATTENTION
Found a swap file by the name ".RiskMgrGARCHHelper.py.swp"
[10Cowned by: bae   dated: Thu Nov  8 10:26:30 2018
[9Cfile name: ~bae/recommend_model/asset_allocation_v2/RiskMgrGARCHHelper.py
[10Cmodified: no
[9Cuser name: bae   host name: fd3d2f0db4d6
[8Cprocess ID: 1252 (still running)
While opening file "RiskMgrGARCHHelper.py"

(1) Another program may be editing the same file.  If this is the case,
    be careful not to end up with two different instances of the same
    file when making changes.  Quit, or continue with caution.
(2) An edit session for this file crashed.
    If this is the case, use ":recover" or "vim -r RiskMgrGARCHHelper.py"
    to recover the changes (see ":help recovery").
    If you did this already, delete the swap file ".RiskMgrGARCHHelper.py.swp"
    to avoid this message.

Swap file ".RiskMgrGARCHHelper.py.swp" already exists!
[O]pen Read-Only, (E)dit anyway, (R)ecover, (Q)uit, (A)bort:[?12l[?25h[64;1H[K[?25l[64;1H"RiskMgrGARCHHelper.py" [New File][>c[2;1H[1m[34m~                                                                                                                                                                                        [3;1H~                                                                                                                                                                                        [4;1H~                                                                                                                                                                                        [5;1H~                                                                                                                                                                                        [6;1H~                                                                                                                                                                                        [7;1H~                                                                                                                                                                                        [8;1H~                                                                                                                                                                                        [9;1H~                                                                                                                                                                                        [10;1H~                                                                                                                                                                                        [11;1H~                                                                                                                                                                                        [12;1H~                                                                                                                                                                                        [13;1H~                                                                                                                                                                                        [14;1H~                                                                                                                                                                                        [15;1H~                                                                                                                                                                                        [16;1H~                                                                                                                                                                                        [17;1H~                                                                                                                                                                                        [18;1H~                                                                                                                                                                                        [19;1H~                                                                                                                                                                                        [20;1H~                                                                                                                                                                                        [21;1H~                                                                                                                                                                                        [22;1H~                                                                                                                                                                                        [23;1H~                                                                                                                                                                                        [24;1H~                                                                                                                                                                                        [25;1H~                                                                                                                                                                                        [26;1H~                                                                                                                                                                                        [27;1H~                                                                                                                                                                                        [28;1H~                                                                                                                                                                                        [29;1H~                                                                                                                                                                                        [30;1H~                                                                                                                                                                                        [31;1H~                                                                                                                                                                                        [32;1H~                                                                                                                                                                                        [33;1H~                                                                                                                                                                                        [34;1H~                                                                                                                                                                                        [35;1H~                                                                                                                                                                                        [36;1H~                                                                                                                                                                                        [37;1H~                                                                                                                                                                                        [38;1H~                                                                                                                                                                                        [39;1H~                                                                                                                                                                                        [40;1H~                                                                                                                                                                                        [41;1H~                                                                                                                                                                                        [42;1H~                                                                                                                                                                                        [43;1H~                                                                                                                                                                                        [44;1H~                                                                                                                                                                                        [45;1H~                                                                                                                                                                                        [46;1H~                                                                                                                                                                                        [47;1H~                                                                                                                                                                                        [48;1H~                                                                                                                                                                                        [49;1H~                                                                                                                                                                                        [50;1H~                                                                                                                                                                                        [51;1H~                                                                                                                                                                                        [52;1H~                                                                                                                                                                                        [53;1H~                                                                                                                                                                                        [54;1H~                                                                                                                                                                                        [55;1H~                                                                                                                                                                                        [56;1H~                                                                                                                                                                                        [57;1H~                                                                                                                                                                                        [58;1H~                                                                                                                                                                                        [59;1H~                                                                                                                                                                                        [60;1H~                                                                                                                                                                                        [61;1H~                                                                                                                                                                                        [62;1H~                                                                                                                                                                                        [63;1H~                                                                                                                                                                                        [m[64;168H0,0-1[9CAll[1;1H[?12l[?25h[?25l[34m#[m[64;168H1,1  [1;1H[?12l[?25h[64;1H
[?1l>[?1049l
[5]+  Stopped                 vim RiskMgrGARCHHelper.py
]0;bae@fd3d2f0db4d6:~/recommend_model/asset_allocation_v2[bae@fd3d2f0db4d6 asset_allocation_v2]$ python3 RiskMgrGARCHHep[Klper.py
python3: can't open file 'RiskMgrGARCHHelper.py': [Errno 2] No such file or directory
]0;bae@fd3d2f0db4d6:~/recommend_model/asset_allocation_v2[bae@fd3d2f0db4d6 asset_allocation_v2]$ vi RiskMgrLow.py
[?1049h[?1h=[2;1H‚ñΩ[6n[1;1H  [1;1H[1;64r[?12;25h[?12l[?25h[27m[m[H[2J[?25l[64;1H"RiskMgrLow.py" [New File][>c[2;1H[1m[34m~                                                                                                                                                                                        [3;1H~                                                                                                                                                                                        [4;1H~                                                                                                                                                                                        [5;1H~                                                                                                                                                                                        [6;1H~                                                                                                                                                                                        [7;1H~                                                                                                                                                                                        [8;1H~                                                                                                                                                                                        [9;1H~                                                                                                                                                                                        [10;1H~                                                                                                                                                                                        [11;1H~                                                                                                                                                                                        [12;1H~                                                                                                                                                                                        [13;1H~                                                                                                                                                                                        [14;1H~                                                                                                                                                                                        [15;1H~                                                                                                                                                                                        [16;1H~                                                                                                                                                                                        [17;1H~                                                                                                                                                                                        [18;1H~                                                                                                                                                                                        [19;1H~                                                                                                                                                                                        [20;1H~                                                                                                                                                                                        [21;1H~                                                                                                                                                                                        [22;1H~                                                                                                                                                                                        [23;1H~                                                                                                                                                                                        [24;1H~                                                                                                                                                                                        [25;1H~                                                                                                                                                                                        [26;1H~                                                                                                                                                                                        [27;1H~                                                                                                                                                                                        [28;1H~                                                                                                                                                                                        [29;1H~                                                                                                                                                                                        [30;1H~                                                                                                                                                                                        [31;1H~                                                                                                                                                                                        [32;1H~                                                                                                                                                                                        [33;1H~                                                                                                                                                                                        [34;1H~                                                                                                                                                                                        [35;1H~                                                                                                                                                                                        [36;1H~                                                                                                                                                                                        [37;1H~                                                                                                                                                                                        [38;1H~                                                                                                                                                                                        [39;1H~                                                                                                                                                                                        [40;1H~                                                                                                                                                                                        [41;1H~                                                                                                                                                                                        [42;1H~                                                                                                                                                                                        [43;1H~                                                                                                                                                                                        [44;1H~                                                                                                                                                                                        [45;1H~                                                                                                                                                                                        [46;1H~                                                                                                                                                                                        [47;1H~                                                                                                                                                                                        [48;1H~                                                                                                                                                                                        [49;1H~                                                                                                                                                                                        [50;1H~                                                                                                                                                                                        [51;1H~                                                                                                                                                                                        [52;1H~                                                                                                                                                                                        [53;1H~                                                                                                                                                                                        [54;1H~                                                                                                                                                                                        [55;1H~                                                                                                                                                                                        [56;1H~                                                                                                                                                                                        [57;1H~                                                                                                                                                                                        [58;1H~                                                                                                                                                                                        [59;1H~                                                                                                                                                                                        [60;1H~                                                                                                                                                                                        [61;1H~                                                                                                                                                                                        [62;1H~                                                                                                                                                                                        [63;1H~                                                                                                                                                                                        [m[64;168H0,0-1[9CAll[1;1H[?12l[?25h[64;1H
[?1l>[?1049l
[6]+  Stopped                 vim RiskMgrLow.py
]0;bae@fd3d2f0db4d6:~/recommend_model/asset_allocation_v2[bae@fd3d2f0db4d6 asset_allocation_v2]$ ls RiskMgrLow.py
ls: cannot access RiskMgrLow.py: No such file or directory
]0;bae@fd3d2f0db4d6:~/recommend_model/asset_allocation_v2[bae@fd3d2f0db4d6 asset_allocation_v2]$ cde [K[K[K[Kls
factor.sh  [0m[01;34mscript[0m  [01;34mshell[0m  typescript
]0;bae@fd3d2f0db4d6:~/recommend_model/asset_allocation_v2[bae@fd3d2f0db4d6 asset_allocation_v2]$ cd shell
]0;bae@fd3d2f0db4d6:~/recommend_model/asset_allocation_v2/shell[bae@fd3d2f0db4d6 shell]$ ls RiskMgrLow.py
RiskMgrLow.py
]0;bae@fd3d2f0db4d6:~/recommend_model/asset_allocation_v2/shell[bae@fd3d2f0db4d6 shell]$ vi RiskMgrLow.py
[?1049h[?1h=[2;1H‚ñΩ[6n[1;1H  [1;1H[1;64r[?12;25h[?12l[?25h[27m[m[H[2J[?25l[64;1H"RiskMgrLow.py" 97L, 3234C[>c[1;1H[34m# -*- coding: utf-8 -*-[m
[31m"""
Created at Nov 23, 2016
Author: shengyitao
Contact: shengyitao@licaimofang.com
Company: LCMF
"""[m


[35mimport[m pandas [33mas[m pd
[35mimport[m datetime
[35mimport[m numpy [33mas[m np
[35mimport[m utils
[35mimport[m os
[35mimport[m sys
[35mimport[m click
[35mimport[m DFUtil
[35mfrom[m scipy [35mimport[m stats
[35mimport[m random[23;1H[33mclass[m [36mRiskMgrLow[m([36mobject[m):[25;5H[33mdef[m [36m__init__[m(self, empty=[31m25[m, maxdd=-[31m0.075[m, mindd=-[31m0.05[m, period=[31m252[m):[26;9Hself.maxdd = maxdd[27;9Hself.mindd = mindd[28;9Hself.empty = empty[29;9Hself.period = period[31;5H[33mdef[m [36mperform[m(self, asset, df_input):[32;9H[34m#[m[33;9Hdf = pd.DataFrame({[34;13H[31m'nav'[m : df_input[[31m'nav'[m],[35;13H[31m'max'[m: df_input[[31m'nav'[m].rolling([31m25[m).[36mmax[m(),[36;9H})[38;9H[34m#[39;9H# status: 0:‰∏çÂú®È£éÊéß‰∏≠; 1:È£éÊéß‰∏≠[40;9H# action: 0:Êó†È£éÊéß; 2:2Êó•Êî∂ÁõäÁéáËß¶ÂèëÈ£éÊéß; 3:3Êó•Êî∂ÁõäÁéáËß¶ÂèëÈ£éÊéß; 5:5Êó•Êî∂ÁõäÁéáËß¶ÂèëÈ£éÊéß; 6:Êó†Êù°‰ª∂Á©∫‰ªì; 7:Êó†Êù°‰ª∂Á©∫‰ªìÁªìÊùüÁ≠âÊã©Êó∂Âä†‰ªì‰ø°Âè∑; 8:Êã©Êó∂Êª°‰ªì[41;9H#[42;9H# È£éÊéßÈÄªËæë:[43;9H#[44;9H#    1. if (‰∫îÊó•Êî∂ÁõäÁéá‰∏ãË∑åÂà∞99%ÁΩÆ‰ø°Âå∫Èó¥Â§ñ ‰∏î < -0.03) ÊàñËÄÖ (2Êó•Êàñ3Êó•Êî∂ÁõäÁéá < -7.5%) ÂàôÂêØÂä®È£éÊéß, ÂºÄÂßãÁ©∫‰ªì.[45;9H#[46;9H#    2. ÂêØÂä®È£éÊéßÂêéÊ